<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š Daily Researcher - éé—æ‰‹å·¥å‡ºæµ·å…¨çƒè¶‹åŠ¿æ´å¯Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .loading-spinner {display:inline-block;width:20px;height:20px;border:2px solid #f3f3f3;border-top:2px solid #3498db;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .date-selector {background:white;padding:1rem;border-radius:12px;margin-bottom:1.5rem;box-shadow:0 2px 10px rgba(0,0,0,0.1);display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
        .date-selector select {padding:0.5rem 1rem;border:2px solid #3498db;border-radius:8px;font-size:1rem;cursor:pointer;background:white;min-width:150px}
        .current-badge {background:#27ae60;color:white;padding:0.3rem 0.8rem;border-radius:20px;font-size:0.8rem;margin-left:auto}
    </style>
</head>
<body>
    <header>
        <h1>ğŸ“Š Daily Researcher</h1>
        <p>éé—æ‰‹å·¥å‡ºæµ· Â· å…¨çƒè¶‹åŠ¿æ´å¯Ÿä»ªè¡¨æ¿</p>
        <p class="last-updated">æœ€åæ›´æ–°ï¼š<span id="update-time">åŠ è½½ä¸­...</span></p>
    </header>
    <nav>
        <a href="index.html" class="active">ä»ªè¡¨æ¿</a>
        <a href="competitor.html">ç«å“åŠ¨æ€</a>
        <a href="social.html">ç¤¾äº¤è¶‹åŠ¿</a>
        <a href="supply-chain.html">ä¾›åº”é“¾æœˆæŠ¥</a>
    </nav>
    <main>
        <div class="date-selector">
            <label>ğŸ“… é€‰æ‹©æ—¥æœŸï¼š</label>
            <select id="date-select" onchange="loadDataByDate()"><option value="">åŠ è½½ä¸­...</option></select>
            <span class="current-badge" id="current-badge">åŠ è½½ä¸­...</span>
        </div>
        <section class="metrics">
            <div class="metric-card">
                <h3>ğŸ”¥ ä»Šæ—¥çƒ­ç‚¹</h3>
                <ul id="hot-topics"><li style="padding:1rem;text-align:center;color:#7f8c8d"><span class="loading-spinner"></span>åŠ è½½ä¸­...</li></ul>
            </div>
            <div class="metric-card">
                <h3>ğŸ·ï¸ çƒ­é—¨æ ‡ç­¾</h3>
                <div id="tag-cloud" class="tag-cloud" style="padding:1rem;text-align:center;color:#7f8c8d"><span class="loading-spinner"></span>åŠ è½½ä¸­...</div>
            </div>
        </section>
        <section class="charts">
            <div class="chart-container">
                <h3>ğŸ“ˆ è¶‹åŠ¿çƒ­åº¦å˜åŒ–</h3>
                <canvas id="trendChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>ğŸ¥§ å“ç±»åˆ†å¸ƒ</h3>
                <canvas id="categoryChart"></canvas>
            </div>
        </section>
        <section class="quick-links">
            <h3>ğŸ“± å¿«é€ŸæŸ¥çœ‹</h3>
            <div class="link-cards">
                <a href="competitor.html" class="link-card"><span class="icon">ğŸ›’</span><span class="title">ç«å“åŠ¨æ€</span><span class="desc">Amazon/Etsy/TikTok Shop</span></a>
                <a href="social.html" class="link-card"><span class="icon">ğŸ¨</span><span class="title">ç¤¾äº¤è¶‹åŠ¿</span><span class="desc">TikTok/Pinterest/IPçƒ­ç‚¹</span></a>
                <a href="supply-chain.html" class="link-card"><span class="icon">ğŸ“¦</span><span class="title">ä¾›åº”é“¾æœˆæŠ¥</span><span class="desc">å…¨å›½äº§åŒº/åŸææ–™</span></a>
            </div>
        </section>
    </main>
    <footer><p>ğŸ“Š Daily Researcher | éé—æ‰‹å·¥å‡ºæµ·è¶‹åŠ¿æ´å¯Ÿ</p><p>æ•°æ®æ¥æºï¼šAmazon, Etsy, TikTok Shop, Pinterest</p></footer>
    <script>
    // å·¥å…·å‡½æ•°
    function formatDate(date) {
        return new Date(date).toLocaleString('zh-CN', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    }
    function formatNumber(num) {
        if(num>=1000000000) return (num/1000000000).toFixed(1)+'B';
        if(num>=1000000) return (num/1000000).toFixed(1)+'M';
        if(num>=1000) return (num/1000).toFixed(1)+'K';
        return num.toString();
    }
    function getTagSize(count, maxCount) {
        var ratio = count/maxCount;
        if(ratio>0.8) return 'size-5';
        if(ratio>0.6) return 'size-4';
        if(ratio>0.4) return 'size-3';
        if(ratio>0.2) return 'size-2';
        return 'size-1';
    }

    // å…¨å±€å˜é‡
    var currentDate = new Date().toISOString().split('T')[0];
    var availableDates = [];

    // æ‰«æå¯ç”¨æ—¥æœŸ
    function scanAvailableDates() {
        fetch('data/competitor/')
            .then(function(r){ return r.text() })
            .then(function(text){
                var matches = text.match(/2026-\d{2}-\d{2}/g);
                var dates = matches ? [...new Set(matches)].sort().reverse() : ['2026-02-07','2026-02-06','2026-02-05','2026-02-04'];
                
                // éªŒè¯æ¯ä¸ªæ—¥æœŸæ˜¯å¦æœ‰JSONæ–‡ä»¶
                var promises = dates.map(function(d){
                    return fetch('data/competitor/'+d+'.json')
                        .then(function(r){ return r.ok ? d : null })
                        .catch(function(){ return null });
                });
                
                Promise.all(promises).then(function(validDates){
                    availableDates = validDates.filter(function(d){ return d !== null });
                    if(availableDates.length === 0) {
                        availableDates = ['2026-02-07','2026-02-06','2026-02-05','2026-02-04'];
                    }
                    
                    var select = document.getElementById('date-select');
                    select.innerHTML = '';
                    availableDates.forEach(function(d){
                        var cn = d.replace(/(\d{4})-(\d{2})-(\d{2})/, '$1å¹´$2æœˆ$3æ—¥');
                        var opt = document.createElement('option');
                        opt.value = d;
                        opt.textContent = cn;
                        select.appendChild(opt);
                    });
                    
                    var today = new Date().toISOString().split('T')[0];
                    currentDate = availableDates.includes(today) ? today : availableDates[0];
                    select.value = currentDate;
                    
                    document.getElementById('current-badge').textContent = 'æœ€æ–°æ•°æ®';
                    initDashboard();
                });
            })
            .catch(function(){
                availableDates = ['2026-02-07','2026-02-06','2026-02-05','2026-02-04'];
                var select = document.getElementById('date-select');
                availableDates.forEach(function(d){
                    var opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d.replace(/(\d{4})-(\d{2})-(\d{2})/, '$1å¹´$2æœˆ$3æ—¥');
                    select.appendChild(opt);
                });
                currentDate = availableDates[0];
                initDashboard();
            });
    }

    // åŠ è½½æŒ‡å®šæ—¥æœŸæ•°æ®
    function loadDataByDate() {
        var select = document.getElementById('date-select');
        currentDate = select.value;
        var today = new Date().toISOString().split('T')[0];
        var badge = document.getElementById('current-badge');
        badge.textContent = currentDate === today ? 'æœ€æ–°æ•°æ®' : 'å†å²æ•°æ®';
        badge.style.background = currentDate === today ? '#27ae60' : '#f39c12';
        
        document.getElementById('hot-topics').innerHTML = '<li style="padding:1rem;text-align:center"><span class="loading-spinner"></span>åŠ è½½ä¸­...</li>';
        document.getElementById('tag-cloud').innerHTML = '<span style="color:#7f8c8d"><span class="loading-spinner"></span>åŠ è½½ä¸­...</span>';
        
        initDashboard();
    }

    // åˆå§‹åŒ–ä»ªè¡¨æ¿
    function initDashboard() {
        console.log('Dashboard init', currentDate);
        document.getElementById('update-time').textContent = formatDate(new Date());
        
        fetch('data/competitor/'+currentDate+'.json')
            .then(function(r){ 
                if(!r.ok) throw new Error('No data');
                return r.json();
            })
            .then(function(data){
                console.log('Data loaded', data);
                
                // æ¸²æŸ“çƒ­ç‚¹äº§å“
                var hotContainer = document.getElementById('hot-topics');
                if(data.hotProducts && data.hotProducts.length > 0) {
                    hotContainer.innerHTML = data.hotProducts.slice(0,5).map(function(p, i){
                        return '<li class="product-item"><span class="product-rank">'+(i+1)+'</span>'+
                            '<div class="product-info"><div class="product-name">'+p.name+'</div>'+
                            '<div class="product-meta">'+p.platform+' Â· '+p.price+'</div></div>'+
                            '<span class="product-price">'+p.sales+'</span></li>';
                    }).join('');
                } else {
                    hotContainer.innerHTML = '<li style="padding:1rem;color:#7f8c8d">æš‚æ— æ•°æ®</li>';
                }
                
                // æ¸²æŸ“æ ‡ç­¾äº‘
                var tagContainer = document.getElementById('tag-cloud');
                if(data.trendingTags && data.trendingTags.length > 0) {
                    var maxCount = Math.max.apply(Math, data.trendingTags.slice(0,15).map(function(t){ return t.count || 1 }));
                    tagContainer.innerHTML = data.trendingTags.slice(0,15).map(function(t){
                        return '<span class="tag '+getTagSize(t.count||1, maxCount)+'">'+t.name+'</span>';
                    }).join('');
                } else {
                    tagContainer.innerHTML = '<span style="color:#7f8c8d">æš‚æ— æ ‡ç­¾æ•°æ®</span>';
                }
                
                // æ¸²æŸ“å›¾è¡¨
                if(data.trendData && document.getElementById('trendChart')) {
                    var ctx1 = document.getElementById('trendChart').getContext('2d');
                    new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: data.trendData.labels,
                            datasets: data.trendData.datasets.map(function(d, i){
                                return {
                                    label: d.label,
                                    data: d.data,
                                    borderColor: ['#3498db','#e74c3c','#27ae60'][i%3],
                                    backgroundColor: 'transparent',
                                    tension: 0.4,
                                    fill: false
                                };
                            })
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom' } },
                            scales: { y: { beginAtZero: false } }
                        }
                    });
                }
                
                if(data.categoryDistribution && document.getElementById('categoryChart')) {
                    var ctx2 = document.getElementById('categoryChart').getContext('2d');
                    new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: data.categoryDistribution.labels,
                            datasets: [{
                                data: data.categoryDistribution.data,
                                borderWidth: 2,
                                borderColor: '#fff',
                                backgroundColor: ['#3498db','#e74c3c','#27ae60','#f39c12','#9b59b6','#1abc9c']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'right' } }
                        }
                    });
                }
                
                console.log('Dashboard rendered');
            })
            .catch(function(e){
                console.error('Error', e);
                document.getElementById('hot-topics').innerHTML = '<li style="padding:1rem;color:#e74c3c">æ•°æ®åŠ è½½å¤±è´¥</li>';
                document.getElementById('tag-cloud').innerHTML = '<span style="color:#e74c3c">æ•°æ®åŠ è½½å¤±è´¥</span>';
            });
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    if(document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', scanAvailableDates);
    } else {
        scanAvailableDates();
    }
    </script>
</body>
</html>
